<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.A.B CONTABILIDADE</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="icon" type="image/jpg" href="{{ url_for('static', filename='logo.jpg') }}">
    <script>
        window.addEventListener("beforeunload", function () {
            navigator.sendBeacon("/shutdown");
        });
    </script>

    <style>
        .fundo {
            position: fixed;        /* fixa no fundo da tela */
            bottom: 0;              /* sempre no rodap√© */
            left: 0;
            width: 100%;            /* ocupa toda a largura */
            text-align: center;     /* centraliza a imagem */
            z-index: -1;            /* joga atr√°s do conte√∫do */
        }

        .fundo img {
            max-width: 20%;         /* tamanho padr√£o */
            height: auto;
            transition: all 0.3s ease; /* anima√ß√£o suave na troca */
        }

        /* Responsivo */
        @media (max-width: 768px) {
            body {
                background-size: 70% auto;
            }
        }
        @media (max-width: 480px) {
            body {
                background-size: 50% auto;
            }
        }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- <h1 class="mb-4 text-center fs-3 fs-md-2 fs-lg-1">
    Sistema de Emiss√£o e Consulta - G.A.BRESCIANI CONTABILIDADE
    </h1> -->

    <div class="d-flex align-items-center justify-content-center mb-4">
        <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo" class="me-3" style="height: 50px;">
        <h1 class="fs-3 fs-md-2 fs-lg-1 text-center m-0">
            Sistema de Emiss√£o e Consulta - G.A.B CONTABILIDADE
        </h1>
    </div>

    <!-- Nav Tabs -->
    <div class="d-flex justify-content-center">
        <ul class="nav nav-tabs col-md-8" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="emissao-tab" data-bs-toggle="tab" data-bs-target="#emissao" type="button" role="tab" aria-controls="emissao" aria-selected="true">Emiss√£o</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta" type="button" role="tab" aria-controls="consulta" aria-selected="false">Consultar</button>
            </li>
        </ul>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content p-4 border border-top-0 rounded-bottom bg-light col-md-8 mx-auto" id="myTabContent">

        <!-- Emiss√£o -->
        <div class="tab-pane fade show active" id="emissao" role="tabpanel" aria-labelledby="emissao-tab">
            <form id="form-processar" method="post" enctype="multipart/form-data" class="row g-3">
                <div class="col-md-12">
                    <label for="arquivo" class="form-label">Selecionar Arquivo</label>
                    <input type="file" class="form-control" name="arquivo" id="arquivo" required>
                </div>

                <!-- <div class="col-md-6">
                    <label class="form-label">Execu√ß√£o</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="background" name="tipo_background" value="Segundo Plano">
                        <label class="form-check-label" for="background">Segundo Plano</label>
                    </div>
                </div> -->
                
                <div class="col-8">
                    <button type="button" id="btn-processar" class="btn btn-primary">Processar</button>
                </div>
            </form>
        </div>

        <!-- Consultar -->
        <div class="tab-pane fade" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">
            <form id="form-consulta" method="post" enctype="multipart/form-data" class="row g-3">
                
                <div class="col-md-12">
                    <label for="arquivo_consulta" class="form-label">Selecionar Arquivo</label>
                    <input type="file" class="form-control" name="arquivo_consulta" id="arquivo_consulta">
                </div>

                <div class="col-md-12">
                    <label for="diretorio" class="form-label">Diret√≥rio de Armazenamento</label>
                    <div class="input-group">
                        <input type="text" id="diretorio" name="diretorio" class="form-control" readonly>
                        <button type="button" id="btn-selecionar-pasta" class="btn btn-secondary">Selecionar Pasta</button>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <label for="data-inicial" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="data-inicial" name="data_inicial">
                    </div>
                    <div class="col-md-4">
                        <label for="data-final" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="data-final" name="data_final">
                    </div>
                    <div class="col-md-4">
                        <label for="mesSelect" class="form-label">Selecione o M√™s</label>
                        <select class="form-select" id="mesSelect" name="mes_referencia" aria-label="Selecione o m√™s">
                            <option selected>Selecione...</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <label class="form-label">Tipo de Arquivo</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pdf" name="tipo_pdf" value="PDF" checked>
                            <label class="form-check-label" for="pdf">PDF</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="xml" name="tipo_xml" value="XML" checked>
                            <label class="form-check-label" for="xml">XML</label>
                        </div>
                    </div>
                    <!-- <div class="col-md-3">
                        <label class="form-label">Execu√ß√£o</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="background" name="tipo_background" value="Segundo Plano">
                            <label class="form-check-label" for="background">Segundo Plano</label>
                        </div>
                    </div> -->
                </div>

                <div class="col-12 mt-3">
                    <button type="button" id="btn-consultar" name="acao" value="consultar" class="btn btn-success">Consultar</button>
                </div>
            </form>
        </div>
    
    <div id="progress-container" class="my-3 col-8 mx-auto" style="display:none;">
        <div class="progress">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
        </div>
    </div>

    <div></div>

    <!-- Fundo separado -->
    <div class="fundo">
        <img id="fundo-img" src="{{ url_for('static', filename='logo.jpg') }}" alt="">
         <p>Desenvolvido por <strong>Denis Menegon</strong> ‚Äî üì± (19) 99493-4477</p>
    </div>
</div>

<script>
    const larguraTela = window.innerWidth;
    const alturaTela = window.innerHeight;
    
    let largura, altura;

    function ajustarFundo(aba) {
        const img = document.getElementById("fundo-img");

        if (aba === "emissao") {
            img.style.maxWidth = "20%";
        }

        if (aba === "consulta") {
            largura = "10%";
            altura = "auto";
            // if (larguraTela <= 1000) { largura = "10%"; altura = "auto%"; }
     
            // if (larguraTela <= 768) { largura = "9%"; altura = "9%"; }
            
            img.style.maxWidth = largura;
            img.style.height   = altura;
        }
    }

    // Inicial
    window.addEventListener("load", () => ajustarFundo("emissao"));

    // Eventos das abas
    document.getElementById("consulta-tab").addEventListener("shown.bs.tab", () => ajustarFundo("consulta"));
    document.getElementById("emissao-tab").addEventListener("shown.bs.tab", () => ajustarFundo("emissao"));

    function atualizarBarra(valor) {
        const barra = document.getElementById("progress-bar");
        barra.style.width = valor + "%";
        barra.innerText = valor + "%";
    }

    function verificarProgresso() {
        fetch("/progresso")
            .then(r => r.json())
            .then(data => {
                document.getElementById("progress-container").style.display = "block";
                atualizarBarra(data.valor);
            });
    }

    document.getElementById("btn-consultar").addEventListener("click", function() {
    const form = document.getElementById("form-consulta");
    const arquivo = document.getElementById("arquivo_consulta");
    const diretorio = document.getElementById("diretorio");

    if (!arquivo.files.length) {
        alert("Por favor, selecione um arquivo de consulta.");
        return;
    }

    if (!diretorio.value.trim()) {
        alert("Por favor, informe o diret√≥rio de armazenamento.");
        return;
    }

    const formData = new FormData(form);
    const button = this;
    button.disabled = true;
    atualizarBarra(0);
    document.getElementById("progress-container").style.display = "block";

        // Envia os dados para o Flask sem recarregar a p√°gina
        fetch("/consultar", {
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.status);
            // Aqui voc√™ pode adicionar uma mensagem de sucesso, se necess√°rio
        })
        .catch(error => {
            console.error("Erro ao iniciar o processo:", error);
            document.getElementById("progress-container").style.display = "none";
        })
        .finally(() => {
            // Reabilita o bot√£o, independentemente de ter tido sucesso ou falha
            button.disabled = false;
        });
    });

    document.getElementById("btn-processar").addEventListener("click", function() {
        const form = document.getElementById("form-processar");
        const formData = new FormData(form);
        const button = this;

        const arquivo = document.getElementById("arquivo");

        if (!arquivo.files.length) {
            alert("Por favor, selecione um arquivo.");
            return;
        }

        // Desabilita o bot√£o
        button.disabled = true;

        // Zera o progresso na interface antes de enviar a requisi√ß√£o
        atualizarBarra(0);
        document.getElementById("progress-container").style.display = "block";

        // Envia os dados para o Flask sem recarregar a p√°gina
        fetch("/processar", {
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.status);
            // Aqui voc√™ pode adicionar uma mensagem de sucesso, se necess√°rio
        })
        .catch(error => {
            console.error("Erro ao iniciar o processo:", error);
            document.getElementById("progress-container").style.display = "none";
        })
        .finally(() => {
            // Reabilita o bot√£o, independentemente de ter tido sucesso ou falha
            button.disabled = false;
        });
    });

    document.getElementById("btn-selecionar-pasta").addEventListener("click", function() {
        fetch("/selecionar_pasta")
            .then(res => res.json())
            .then(data => {
                document.getElementById("diretorio").value = data.caminho;
            });
    });

    setInterval(verificarProgresso, 1000);
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
